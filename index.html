// ===== Part 1: ê¸°ë³¸ ì„¤ì • ë° í•µì‹¬ ê¸°ëŠ¥ (ì‹¤ì‹œê°„ ë™ê¸°í™”) =====
const firebaseConfig = {
  apiKey: "AIzaSyDgooYtVr8-jm15-fx_WvGLCDxonLpNPuU",
  authDomain: "hsj-news.firebaseapp.com",
  databaseURL: "https://hsj-news-default-rtdb.firebaseio.com",
  projectId: "hsj-news",
  storageBucket: "hsj-news.firebasestorage.app",
  messagingSenderId: "437842430700",
  appId: "1:437842430700:web:e3822bde4cfecdc04633c9"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

let currentArticlePage = 1;
const ARTICLES_PER_PAGE = 5;
let currentCommentPage = 1;
const COMMENTS_PER_PAGE = 10;
let currentArticleId = null;
let currentSortMethod = 'latest';
let filteredArticles = [];
let allArticles = [];
let bannedWordsList = []; // ê¸ˆì§€ì–´ ëª©ë¡

function setCookie(n, v) { document.cookie = `${n}=${v};path=/`; }
function getCookie(n) {
    const m = document.cookie.match(new RegExp(`(^| )${n}=([^;]+)`));
    return m ? m[2] : null;
}
function deleteCookie(n) { document.cookie = n + '=; Max-Age=0; path=/'; }

function getNickname() {
    const user = auth.currentUser;
    return user ? user.displayName || user.email.split('@')[0] : "ìµëª…";
}
function getUserEmail() {
    const user = auth.currentUser;
    return user ? user.email : null;
}
function getUserId() {
    const user = auth.currentUser;
    return user ? user.uid : 'anonymous';
}
function isLoggedIn() {
    return auth.currentUser !== null;
}
function isAdmin(){
    return getCookie("is_admin")==="true";
}

// ì¸ë„¤ì¼ ë¯¸ë¦¬ë³´ê¸°
function previewThumbnail(event) {
    const file = event.target.files[0];
    if (file) {
        if (file.size > 500000) {
            alert("ì´ë¯¸ì§€ í¬ê¸°ëŠ” 500KB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤!");
            event.target.value = '';
            return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('thumbnailPreview');
            const uploadText = document.getElementById('uploadText');
            preview.src = e.target.result;
            preview.style.display = 'block';
            uploadText.textContent = 'âœ” ì´ë¯¸ì§€ ì„ íƒë¨ (í´ë¦­í•˜ì—¬ ë³€ê²½)';
        };
        reader.readAsDataURL(file);
    }
}

// ê¸ˆì§€ì–´ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
function loadBannedWords() {
    db.ref("adminSettings/bannedWords").on("value", snapshot => {
        const val = snapshot.val();
        if (val) {
            bannedWordsList = val.split(',').map(s => s.trim()).filter(s => s !== "");
        } else {
            bannedWordsList = [];
        }
    });
}

// ê¸°ì‚¬ ê´€ë¦¬ - Firebase ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ
function setupArticlesListener() {
    db.ref("articles").on("value", snapshot => {
        const val = snapshot.val() || {};
        allArticles = Object.values(val);
        if(document.querySelector(".articles-section.active")) {
            searchArticles(false);
        }
    });
}

function saveArticle(article, callback) {
    if (!article.views) article.views = 0;
    if (!article.likeCount) article.likeCount = 0;
    if (!article.dislikeCount) article.dislikeCount = 0;
    
    db.ref("articles/" + article.id).set(article).then(() => {
        if(callback) callback();
    }).catch(error => {
        alert("ì €ì¥ ì‹¤íŒ¨: " + error.message);
        console.error(error);
    });
}

function deleteArticleFromDB(articleId, callback) {
    db.ref("articles/" + articleId).remove().then(() => {
        db.ref("votes/" + articleId).remove(); 
        if(callback) callback();
    }).catch(error => {
        alert("ì‚­ì œ ì‹¤íŒ¨: " + error.message);
    });
}

function incrementView(id) {
    const viewRef = db.ref(`articles/${id}/views`);
    viewRef.transaction((currentViews) => {
        return (currentViews || 0) + 1;
    });
}

function getArticleViews(article) {
    return article.views || 0;
}

async function checkUserVote(articleId) {
    if (!isLoggedIn()) return null;
    const uid = getUserId();
    const snap = await db.ref(`votes/${articleId}/${uid}`).once('value');
    return snap.val(); 
}

function toggleVote(articleId, voteType) {
    if(!isLoggedIn()) {
        alert("ì¶”ì²œ/ë¹„ì¶”ì²œì€ ë¡œê·¸ì¸ í›„ ê°€ëŠ¥í•©ë‹ˆë‹¤!");
        return;
    }
    
    const uid = getUserId();
    const voteRef = db.ref(`votes/${articleId}/${uid}`);
    const articleRef = db.ref(`articles/${articleId}`);

    voteRef.once('value').then(snapshot => {
        const currentVote = snapshot.val();

        articleRef.transaction(article => {
            if (!article) return article;
            if (!article.likeCount) article.likeCount = 0;
            if (!article.dislikeCount) article.dislikeCount = 0;

            if (currentVote === voteType) {
                if (voteType === 'like') article.likeCount--;
                if (voteType === 'dislike') article.dislikeCount--;
                voteRef.remove(); 
            } 
            else {
                if (currentVote === 'like') article.likeCount--;
                if (currentVote === 'dislike') article.dislikeCount--;

                if (voteType === 'like') article.likeCount++;
                if (voteType === 'dislike') article.dislikeCount++;
                voteRef.set(voteType); 
            }
            return article;
        }).then(() => {
            if (document.querySelector(".article-detail-section.active")) {
                showArticleDetail(articleId);
            }
        });
    });
}

function getArticleVoteCounts(article) {
    return {
        likes: article.likeCount || 0,
        dislikes: article.dislikeCount || 0
    };
}

// UI ë„¤ë¹„ê²Œì´ì…˜
function hideAll() {
    document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
    document.querySelectorAll(".nav-item").forEach(item => item.classList.remove("active"));
}
function showArticles() {
    hideAll();
    document.querySelector(".articles-section").classList.add("active");
    document.querySelectorAll(".nav-item")[0].classList.add("active");
    
    currentArticlePage = 1;
    document.getElementById("searchCategory").value = "";
    document.getElementById("searchKeyword").value = "";
    filteredArticles = allArticles;
    renderArticles();
}
function showWritePage() {
    hideAll();
    document.querySelector(".write-section").classList.add("active");
    document.querySelectorAll(".nav-item")[1].classList.add("active");
}
function showSettings() {
    hideAll();
    document.querySelector(".settings-section").classList.add("active");
    document.querySelectorAll(".nav-item")[2].classList.add("active");
    updateSettings();
}

function showQnA() {
    hideAll();
    document.querySelector(".qna-section").classList.add("active");
    loadQnAFromFile();
}

function loadQnAFromFile() {
    const listDiv = document.getElementById("qnaList");
    fetch('QnA.html')
        .then(response => {
            if (!response.ok) throw new Error("QnA.html íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return response.text();
        })
        .then(html => {
            listDiv.innerHTML = html;
        })
        .catch(err => {
            console.error(err);
            listDiv.innerHTML = `
                <div style="text-align:center; padding:30px; color:#c62828; background:#fff0f0; border-radius:8px;">
                    <p><b>âš ï¸ QnAë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</b></p>
                    <p style="font-size:13px; margin-top:10px;">
                        VSCì˜ <b>Live Server</b> í™•ì¥ í”„ë¡œê·¸ë¨ì„ ì‚¬ìš©í•´ì„œ ì—´ì–´ì£¼ì„¸ìš”.
                    </p>
                </div>
            `;
        });
}

function searchArticles(resetPage = true) {
    const category = document.getElementById("searchCategory").value;
    const keyword = document.getElementById("searchKeyword").value.toLowerCase();
    let articles = [...allArticles];
    
    if(category) {
        articles = articles.filter(a => a.category === category);
    }
    if(keyword) {
        articles = articles.filter(a => 
            a.title.toLowerCase().includes(keyword) || 
            a.content.toLowerCase().includes(keyword) ||
            (a.summary && a.summary.toLowerCase().includes(keyword))
        );
    }
    
    filteredArticles = articles;
    if(resetPage) currentArticlePage = 1;
    renderArticles();
}

function sortArticles(method, btn) {
    currentSortMethod = method;
    currentArticlePage = 1;
    document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
    if (btn && btn.classList) btn.classList.add('active');
    renderArticles();
}

function getArticleTimestamp(a) {
    if (!a) return 0;
    if (a.createdAt) return Number(a.createdAt);
    if (a.date) {
        return new Date(a.date).getTime() || 0;
    }
    return 0;
}

function getSortedArticles() {
    let articles = Array.isArray(filteredArticles) ? [...filteredArticles] : [];
    
    switch(currentSortMethod) {
        case 'latest':
            articles.sort((a,b) => getArticleTimestamp(b) - getArticleTimestamp(a));
            break;
        case 'oldest':
            articles.sort((a,b) => getArticleTimestamp(a) - getArticleTimestamp(b));
            break;
        case 'views':
            articles.sort((a,b) => (b.views || 0) - (a.views || 0));
            break;
        case 'likes':
            articles.sort((a,b) => (b.likeCount || 0) - (a.likeCount || 0));
            break;
        default:
            articles.sort((a,b) => getArticleTimestamp(b) - getArticleTimestamp(a));
            break;
    }
    return articles;
}

// [ìˆ˜ì •] ê¸°ì‚¬ ì‘ì„±: ì‹¤ì‹œê°„ ê¸ˆì§€ì–´ ê°ì§€ ë° ê²½ê³  ë¶€ì—¬
function restoreFormDefaultBehavior() {
    const form = document.getElementById("articleForm");
    const newForm = form.cloneNode(true);
    form.parentNode.replaceChild(newForm, form);
    
    // ì…ë ¥ í•„ë“œ ìš”ì†Œë“¤
    const titleInput = newForm.querySelector("#title");
    const summaryInput = newForm.querySelector("#summary");
    const contentInput = newForm.querySelector("#content");
    const warningEl = newForm.querySelector("#bannedWordWarning");
    
    // ì‹¤ì‹œê°„ ê²€ì‚¬ í•¨ìˆ˜
    function checkInputs() {
        const combinedText = (titleInput.value + " " + summaryInput.value + " " + contentInput.value);
        const foundWord = checkBannedWords(combinedText);
        
        if (foundWord) {
            warningEl.textContent = `ğŸš« ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ë‹¨ì–´ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤: "${foundWord}"`;
            warningEl.style.display = "block";
        } else {
            warningEl.style.display = "none";
        }
    }
    
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° (ì…ë ¥í•  ë•Œë§ˆë‹¤ ì²´í¬)
    titleInput.addEventListener("input", checkInputs);
    summaryInput.addEventListener("input", checkInputs);
    contentInput.addEventListener("input", checkInputs);

    const newFileInput = newForm.querySelector('#thumbnailInput');
    newFileInput.addEventListener('change', previewThumbnail);
    
    newForm.addEventListener("submit", function(e) {
        e.preventDefault();
        if(!isLoggedIn()) {
            alert("ê¸°ì‚¬ ì‘ì„±ì€ ë¡œê·¸ì¸ í›„ ê°€ëŠ¥í•©ë‹ˆë‹¤!");
            return;
        }

        const title = titleInput.value;
        const content = contentInput.value;
        const summary = summaryInput.value;

        // ìµœì¢… ì œì¶œ ì‹œ ê¸ˆì§€ì–´ ì²´í¬ (ë¬´ì‹œí•˜ê³  ì œì¶œ ì‹œ ê²½ê³ )
        const foundWord = checkBannedWords(title + " " + content + " " + summary);
        if (foundWord) {
            alert(`âš ï¸ ê¸ˆì§€ì–´("${foundWord}")ê°€ í¬í•¨ëœ ê¸°ì‚¬ë¥¼ ì—…ë¡œë“œí•˜ë ¤ê³  ì‹œë„í•˜ì—¬, ì—…ë¡œë“œê°€ ì°¨ë‹¨ë˜ê³  ê²½ê³  1íšŒê°€ ëˆ„ì ë©ë‹ˆë‹¤.`);
            addWarningToCurrentUser();
            return; // ì—…ë¡œë“œ ì¤‘ë‹¨
        }
        
        const fileInput = newForm.querySelector('#thumbnailInput');
        const A = {
            id: Date.now().toString(),
            category: newForm.querySelector("#category").value,
            title: title,
            summary: summary,
            content: content,
            author: getNickname(),
            authorEmail: getUserEmail(),
            date: new Date().toLocaleString(),
            createdAt: Date.now(), 
            views: 0,
            likeCount: 0,
            dislikeCount: 0,
            thumbnail: null
        };
        
        if(fileInput.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                A.thumbnail = e.target.result;
                saveArticle(A, () => {
                    newForm.reset();
                    document.getElementById('thumbnailPreview').style.display = 'none';
                    document.getElementById('uploadText').textContent = 'ğŸ“· í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì„ íƒì‚¬í•­)';
                    warningEl.style.display = "none"; // ê²½ê³  ìˆ¨ê¹€
                    alert("ê¸°ì‚¬ê°€ ë°œí–‰ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    showArticles();
                });
            };
            reader.readAsDataURL(fileInput.files[0]);
        } else {
            saveArticle(A, () => {
                newForm.reset();
                document.getElementById('thumbnailPreview').style.display = 'none';
                document.getElementById('uploadText').textContent = 'ğŸ“· í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì„ íƒì‚¬í•­)';
                warningEl.style.display = "none"; // ê²½ê³  ìˆ¨ê¹€
                alert("ê¸°ì‚¬ê°€ ë°œí–‰ë˜ì—ˆìŠµë‹ˆë‹¤!");
                showArticles();
            });
        }
    });
}

// ê¸ˆì§€ì–´ ì²´í¬ í•¨ìˆ˜
function checkBannedWords(text) {
    if (!text) return null;
    for (const word of bannedWordsList) {
        if (text.includes(word)) {
            return word;
        }
    }
    return null;
}

// í˜„ì¬ ë¡œê·¸ì¸í•œ ìœ ì €ì—ê²Œ ê²½ê³  ë¶€ì—¬
function addWarningToCurrentUser() {
    const user = auth.currentUser;
    if (!user) return;
    
    db.ref("users/" + user.uid).once("value").then(snapshot => {
        const data = snapshot.val() || {};
        const currentWarnings = (data.warningCount || 0) + 1;
        
        let updates = { warningCount: currentWarnings };
        
        if (currentWarnings >= 3) {
            updates.isBanned = true;
            updates.bannedAt = Date.now();
            alert("ğŸš¨ ëˆ„ì  ê²½ê³  3íšŒë¡œ ì¸í•´ ê³„ì •ì´ ì°¨ë‹¨ë©ë‹ˆë‹¤. ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ë©ë‹ˆë‹¤.");
        } else {
            alert(`í˜„ì¬ ëˆ„ì  ê²½ê³ : ${currentWarnings}íšŒ (3íšŒ ì‹œ ìë™ ì°¨ë‹¨)`);
        }
        
        db.ref("users/" + user.uid).update(updates).then(() => {
            if (currentWarnings >= 3) {
                auth.signOut().then(() => location.reload());
            }
        });
    });
}

async function renderArticles() {
    const list = getSortedArticles();
    
    const adSection = document.getElementById("adSection");
    const pinnedSection = document.getElementById("pinnedSection"); 
    const featured = document.getElementById("featuredArticle");    
    const grid = document.getElementById("articlesGrid");           
    const loadMore = document.getElementById("loadMoreContainer");
    
    const currentUser = getNickname();

    const adsSnapshot = await db.ref("advertisements").once("value");
    const adsData = adsSnapshot.val() || {};
    const ads = Object.values(adsData).sort((a, b) => b.createdAt - a.createdAt);

    const pinsSnapshot = await db.ref("pinnedArticles").once("value");
    const pinnedData = pinsSnapshot.val() || {};
    const pinnedIds = Object.keys(pinnedData);

    const pinnedArticles = [];
    const unpinnedArticles = [];

    list.forEach(article => {
        if (pinnedIds.includes(article.id)) {
            article.pinnedAt = pinnedData[article.id].pinnedAt;
            pinnedArticles.push(article);
        } else {
            unpinnedArticles.push(article);
        }
    });

    pinnedArticles.sort((a, b) => b.pinnedAt - a.pinnedAt);

    if(ads.length > 0) {
        adSection.innerHTML = ads.map(ad => `
            <div style="background:${ad.color};border:2px solid #856404;padding:25px;border-radius:8px;margin-bottom:20px;box-shadow:0 4px 12px rgba(0,0,0,0.1);">
                <div style="display:flex;align-items:center;margin-bottom:12px;">
                    <span style="background:#856404;color:#fff;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700;margin-right:10px;">ê´‘ê³ </span>
                    <h3 style="margin:0;color:#212529;font-size:20px;font-weight:700;">${ad.title}</h3>
                </div>
                <p style="margin:0 0 15px 0;color:#495057;font-size:15px;line-height:1.6;white-space:pre-wrap;">${ad.content}</p>
                ${ad.link ? `<a href="${ad.link}" target="_blank" class="btn btn-dark" style="text-decoration:none;">ìì„¸íˆ ë³´ê¸° â†’</a>` : ''}
            </div>
        `).join('');
    } else {
        adSection.innerHTML = '';
    }

    if(pinnedArticles.length > 0) {
        pinnedSection.innerHTML = pinnedArticles.map(a => {
            const canEdit = isLoggedIn() && ((a.author === currentUser) || isAdmin());
            const views = getArticleViews(a);
            const votes = getArticleVoteCounts(a);
            return `<div class="article-card" style="border:3px solid #ffd700;background:#fffbf0;">
                ${a.thumbnail ? `<img src="${a.thumbnail}" class="article-thumbnail" alt="ì¸ë„¤ì¼">` : '<div class="article-thumbnail">ğŸ“°</div>'}
                <div class="article-content">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;flex-wrap:wrap;">
                        <span class="category-badge">${a.category}</span>
                        <span style="background:#ffd700;color:#000;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700;">ğŸ“Œ ê³ ì •ë¨</span>
                    </div>
                    <h3 style="font-size:18px;font-weight:700;color:#212529;margin-bottom:8px;line-height:1.4;">${a.title}</h3>
                    <p style="font-size:13px;color:#6c757d;line-height:1.5;margin-bottom:10px;">${a.summary||''}</p>
                    <div class="article-meta">
                        <span>${a.author}</span>
                        <div class="article-stats">
                            <span class="stat-item">ğŸ‘ï¸ ${views}</span>
                            <span class="stat-item">ğŸ‘ ${votes.likes}</span>
                            <span class="stat-item">ğŸ‘ ${votes.dislikes}</span>
                        </div>
                    </div>
                    <div class="article-actions">
                        <button onclick="showArticleDetail('${a.id}')" class="btn btn-primary">ì½ê¸°</button>
                        ${canEdit ? `<button onclick="editArticle('${a.id}')" class="btn btn-blue">ìˆ˜ì •</button>` : ''}
                    </div>
                </div>
            </div>`;
        }).join('');
    } else {
        pinnedSection.innerHTML = '';
    }

    if (list.length === 0) {
        featured.innerHTML = `<div style="text-align:center;padding:60px 20px;background:#fff;border-radius:8px;">
            <p style="color:#868e96;font-size:16px;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ê±°ë‚˜ ì‘ì„±ëœ ê¸°ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>`;
        grid.innerHTML = "";
        loadMore.innerHTML = "";
        return;
    }

    let startIdx = 0;
    if(unpinnedArticles.length > 0 && currentArticlePage === 1) {
        const A0 = unpinnedArticles[0];
        startIdx = 1; 
        
        const canEditA0 = isLoggedIn() && ((A0.author === currentUser) || isAdmin());
        const views0 = getArticleViews(A0);
        const votes0 = getArticleVoteCounts(A0);
        
        featured.innerHTML = `<div class="featured-article">
            ${A0.thumbnail ? `<img src="${A0.thumbnail}" class="featured-image" alt="ì¸ë„¤ì¼">` : '<div class="featured-image">ğŸ“°</div>'}
            <div class="featured-content">
                <span class="category-badge">${A0.category}</span>
                <h2 class="article-title" style="font-size:28px;margin-bottom:16px;">${A0.title}</h2>
                <p class="article-summary" style="font-size:16px;margin-bottom:16px;">${A0.summary || ''}</p>
                <div class="article-meta">
                    <span>${A0.author}</span>
                    <span>${A0.date}</span>
                    <div class="article-stats">
                        <span class="stat-item">ğŸ‘ï¸ ${views0}</span>
                        <span class="stat-item">ğŸ‘ ${votes0.likes}</span>
                        <span class="stat-item">ğŸ‘ ${votes0.dislikes}</span>
                    </div>
                </div>
                <div style="margin-top:20px;display:flex;gap:10px;">
                    <button onclick="showArticleDetail('${A0.id}')" class="btn btn-primary">ê¸°ì‚¬ ì½ê¸°</button>
                    ${canEditA0 ? `<button onclick="editArticle('${A0.id}')" class="btn btn-blue">ìˆ˜ì •</button>` : ''}
                </div>
            </div>
        </div>`;
    } else {
        featured.innerHTML = ''; 
    }

    const endIdx = startIdx + (currentArticlePage * ARTICLES_PER_PAGE);
    const displayArticles = unpinnedArticles.slice(startIdx, endIdx);
    
    grid.innerHTML = displayArticles.map(a => {
        const canEdit = isLoggedIn() && ((a.author === currentUser) || isAdmin());
        const views = getArticleViews(a);
        const votes = getArticleVoteCounts(a);
        return `<div class="article-card">
            ${a.thumbnail ? `<img src="${a.thumbnail}" class="article-thumbnail" alt="ì¸ë„¤ì¼">` : '<div class="article-thumbnail">ğŸ“°</div>'}
            <div class="article-content">
                <span class="category-badge">${a.category}</span>
                <h3 class="article-title">${a.title}</h3>
                <p class="article-summary">${a.summary||''}</p>
                <div class="article-meta">
                    <span>${a.author}</span>
                    <div class="article-stats">
                        <span class="stat-item">ğŸ‘ï¸ ${views}</span>
                        <span class="stat-item">ğŸ‘ ${votes.likes}</span>
                        <span class="stat-item">ğŸ‘ ${votes.dislikes}</span>
                    </div>
                </div>
                <div class="article-actions">
                    <button onclick="showArticleDetail('${a.id}')" class="btn btn-primary">ì½ê¸°</button>
                    ${canEdit ? `<button onclick="editArticle('${a.id}')" class="btn btn-blue">ìˆ˜ì •</button>` : ''}
                </div>
            </div>
        </div>`}).join('');
    
    if(endIdx < unpinnedArticles.length) {
        loadMore.innerHTML = `<button onclick="loadMoreArticles()" class="btn btn-gray">
            ê¸°ì‚¬ ë”ë³´ê¸° (${unpinnedArticles.length - endIdx}ê°œ ë‚¨ìŒ)</button>`;
    } else {
        loadMore.innerHTML = "";
    }
}

function loadMoreArticles() {
    currentArticlePage++;
    renderArticles();
}

async function showArticleDetail(id) {
    db.ref("articles/" + id).once("value").then(async snapshot => {
        const A = snapshot.val();
        if(!A) return alert("ì—†ëŠ” ê¸°ì‚¬!");
        
        if (currentArticleId !== id) {
            incrementView(id);
        }
        currentArticleId = id;
        currentCommentPage = 1;
        hideAll();
        document.querySelector(".article-detail-section").classList.add("active");
        
        const currentUser = getNickname();
        const canEdit = isLoggedIn() && ((A.author === currentUser) || isAdmin());
        const views = getArticleViews(A);
        const votes = getArticleVoteCounts(A);
        
        const userVote = await checkUserVote(id);

        const root = document.getElementById("articleDetail");
        root.innerHTML = `<div style="background:#fff;padding:40px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
            <span class="category-badge">${A.category}</span>
            <h1 style="font-size:32px;font-weight:700;margin:20px 0;line-height:1.4;">${A.title}</h1>
            <div class="article-meta" style="padding-bottom:20px;border-bottom:1px solid #dee2e6;">
                <span>${A.author}</span>
                <span>${A.date}</span>
                <span class="stat-item">ğŸ‘ï¸ ${views}</span>
            </div>
            ${A.thumbnail ? `<img src="${A.thumbnail}" style="width:100%;max-height:500px;object-fit:cover;border-radius:8px;margin:30px 0;" alt="ê¸°ì‚¬ ì´ë¯¸ì§€">` : ''}
            <div style="font-size:16px;line-height:1.8;color:#212529;margin:30px 0;white-space:pre-wrap;">${A.content}</div>
            <div style="display:flex;gap:10px;padding-top:20px;border-top:1px solid #dee2e6;">
                <button onclick="toggleVote('${A.id}', 'like')" class="vote-btn ${userVote === 'like' ? 'active' : ''}">
                    ğŸ‘ ì¶”ì²œ ${votes.likes}
                </button>
                <button onclick="toggleVote('${A.id}', 'dislike')" class="vote-btn dislike ${userVote === 'dislike' ? 'active' : ''}">
                    ğŸ‘ ë¹„ì¶”ì²œ ${votes.dislikes}
                </button>
            </div>
            ${canEdit ? `<div style="margin-top:20px;display:flex;gap:10px;">
                <button onclick="editArticle('${A.id}')" class="btn btn-blue">ìˆ˜ì •</button>
                <button onclick="deleteArticle('${A.id}')" class="btn btn-gray">ì‚­ì œ</button>
            </div>` : ''}
        </div>`;
        loadComments(id);
    });
}
function goBack() { 
    currentArticleId = null;
    showArticles(); 
}

function deleteArticle(id) {
    db.ref("articles/" + id).once("value").then(snapshot => {
        const A = snapshot.val();
        if(!A) return alert("ì—†ëŠ” ê¸°ì‚¬!");
        const currentUser = getNickname();
        if(!isLoggedIn() || (A.author !== currentUser && !isAdmin())) {
            return alert("ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤!");
        }
        if(!confirm("ì •ë§ ì´ ê¸°ì‚¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        deleteArticleFromDB(id, () => {
            db.ref("comments/" + id).remove();
            alert("ê¸°ì‚¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            showArticles();
        });
    });
}

function editArticle(id) {
    db.ref("articles/" + id).once("value").then(snapshot => {
        const A = snapshot.val();
        if(!A) return alert("ì—†ëŠ” ê¸°ì‚¬!");
        const currentUser = getNickname();
        if(!isLoggedIn() || (A.author !== currentUser && !isAdmin())) {
            return alert("ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤!");
        }
        hideAll();
        document.querySelector(".write-section").classList.add("active");
        document.getElementById("category").value = A.category;
        document.getElementById("title").value = A.title;
        document.getElementById("summary").value = A.summary || '';
        document.getElementById("content").value = A.content;
        
        if(A.thumbnail) {
            const preview = document.getElementById('thumbnailPreview');
            const uploadText = document.getElementById('uploadText');
            preview.src = A.thumbnail;
            preview.style.display = 'block';
            uploadText.textContent = 'âœ” ê¸°ì¡´ ì´ë¯¸ì§€ (í´ë¦­í•˜ì—¬ ë³€ê²½)';
        }
        
        const form = document.getElementById("articleForm");
        const newForm = form.cloneNode(true);
        form.parentNode.replaceChild(newForm, form);
        
        const newFileInput = newForm.querySelector('#thumbnailInput');
        newFileInput.addEventListener('change', previewThumbnail);
        
        newForm.addEventListener("submit", function(e) {
            e.preventDefault();
            
            const fileInput = newForm.querySelector('#thumbnailInput');
            if(fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    A.thumbnail = e.target.result;
                    saveUpdatedArticle();
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                saveUpdatedArticle();
            }
            
            function saveUpdatedArticle() {
                A.category = newForm.querySelector("#category").value;
                A.title = newForm.querySelector("#title").value;
                A.summary = newForm.querySelector("#summary").value;
                A.content = newForm.querySelector("#content").value;
                A.date = new Date().toLocaleString() + " (ìˆ˜ì •ë¨)";
                
                // ìˆ˜ì • ì‹œ ê¸ˆì§€ì–´ ì²´í¬
                const foundWord = checkBannedWords(A.title + " " + A.content + " " + A.summary);
                if (foundWord) {
                    alert(`âš ï¸ ê¸ˆì§€ì–´("${foundWord}")ê°€ í¬í•¨ë˜ì–´ ìˆì–´ ìˆ˜ì •ì´ ë¶ˆê°€ëŠ¥í•˜ë©°, ê²½ê³  1íšŒê°€ ëˆ„ì ë©ë‹ˆë‹¤.`);
                    addWarningToCurrentUser();
                    return;
                }

                saveArticle(A, () => {
                    newForm.reset();
                    document.getElementById('thumbnailPreview').style.display = 'none';
                    document.getElementById('uploadText').textContent = 'ğŸ“· í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì„ íƒì‚¬í•­)';
                    alert("ê¸°ì‚¬ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    showArticleDetail(id);
                });
            }
        });
    });
}

// ===== Part 2: ëŒ“ê¸€ ë° ì¸ì¦ =====

function loadComments(id) {
    const currentUser = getNickname();
    db.ref("comments/"+id).once("value").then(s=>{
        const val=s.val()||{};
        const commentsList = Object.entries(val).sort((a,b) => new Date(b[1].timestamp) - new Date(a[1].timestamp));
        const root=document.getElementById("comments");
        const countEl = document.getElementById("commentCount");
        countEl.textContent = `(${commentsList.length})`;
        if(!commentsList.length) {
            root.innerHTML = "<p style='color:#868e96;text-align:center;padding:30px;'>ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
            document.getElementById("loadMoreComments").innerHTML = "";
            return;
        }
        const endIdx = currentCommentPage * COMMENTS_PER_PAGE;
        const displayComments = commentsList.slice(0, endIdx);
        root.innerHTML = displayComments.map(([k,v])=>{
            const canEdit = isLoggedIn() && ((v.author === currentUser) || isAdmin());
            return `<div class="comment-card">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                    <div>
                        <span class="comment-author">${v.author}</span>
                        <small style="color:#868e96;margin-left:10px;">${v.timestamp}</small>
                    </div>
                    ${canEdit ? `<div>
                        <button onclick="editComment('${id}','${k}','${v.author}')" class="btn btn-blue" style="height:32px;padding:0 12px;font-size:12px;">ìˆ˜ì •</button>
                        <button onclick="deleteComment('${id}','${k}','${v.author}')" class="btn btn-gray" style="height:32px;padding:0 12px;font-size:12px;margin-left:6px;">ì‚­ì œ</button>
                    </div>` : ''}
                </div>
                <p style="margin:0;line-height:1.6;color:#495057;">${v.text}</p>
            </div>`}).join('');
        const loadMoreBtn = document.getElementById("loadMoreComments");
        if(endIdx < commentsList.length) {
            loadMoreBtn.innerHTML = `<button onclick="loadMoreComments()" class="btn btn-gray">
                ëŒ“ê¸€ ë”ë³´ê¸° (${commentsList.length - endIdx}ê°œ ë‚¨ìŒ)</button>`;
        } else {
            loadMoreBtn.innerHTML = "";
        }
    });
}
function loadMoreComments() {
    currentCommentPage++;
    loadComments(currentArticleId);
}
function submitCommentFromDetail() {
    submitComment(currentArticleId);
}
function submitComment(id){
    if(!isLoggedIn()) {
        alert("ëŒ“ê¸€ ì‘ì„±ì€ ë¡œê·¸ì¸ í›„ ê°€ëŠ¥í•©ë‹ˆë‹¤!");
        return;
    }
    const txt=document.getElementById("commentInput").value.trim();
    if(!txt) return alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
    
    const foundWord = checkBannedWords(txt);
    if (foundWord) {
        alert(`âš ï¸ ê¸ˆì§€ì–´("${foundWord}")ê°€ í¬í•¨ë˜ì–´ ë“±ë¡í•  ìˆ˜ ì—†ìœ¼ë©°, ê²½ê³  1íšŒê°€ ëˆ„ì ë©ë‹ˆë‹¤.`);
        addWarningToCurrentUser();
        return;
    }

    const cid=Date.now().toString();
    const C={author:getNickname(),authorEmail:getUserEmail(),text:txt,timestamp:new Date().toLocaleString()};
    db.ref("comments/"+id+"/"+cid).set(C);
    document.getElementById("commentInput").value="";
    currentCommentPage = 1;
    loadComments(id);
}
function deleteComment(aid, cid, author){
    const currentUser = getNickname();
    if(!isLoggedIn() || (author !== currentUser && !isAdmin())) {
        return alert("ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤!");
    }
    if(!confirm("ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    db.ref("comments/"+aid+"/"+cid).remove();
    loadComments(aid);
}
function editComment(aid, cid, author){
    const currentUser = getNickname();
    if(!isLoggedIn() || (author !== currentUser && !isAdmin())) {
        return alert("ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤!");
    }
    db.ref("comments/"+aid+"/"+cid).once("value").then(s=>{
        const comment = s.val();
        if(!comment) return;
        const newText = prompt("ëŒ“ê¸€ ìˆ˜ì •", comment.text);
        if(newText === null || newText.trim() === "") return;
        
        const foundWord = checkBannedWords(newText);
        if(foundWord) {
            alert(`âš ï¸ ê¸ˆì§€ì–´("${foundWord}")ê°€ í¬í•¨ë˜ì–´ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
            return;
        }

        comment.text = newText.trim();
        comment.timestamp = new Date().toLocaleString() + " (ìˆ˜ì •ë¨)";
        db.ref("comments/"+aid+"/"+cid).set(comment);
        loadComments(aid);
    });
}

// ì‚¬ìš©ì ì„¤ì • ë° ì¸ì¦
async function updateSettings() {
    const el = document.getElementById("profileNickname");
    if (el) {
        const user = auth.currentUser;
        if(user) {
            const nicknameChangeSnapshot = await db.ref("users/" + user.uid + "/nicknameChanged").once("value");
            const hasChangedNickname = nicknameChangeSnapshot.val() || false;
            const userSnapshot = await db.ref("users/" + user.uid).once("value");
            const userData = userSnapshot.val() || {};
            const isVIP = userData.isVIP || false;
            const warningCount = userData.warningCount || 0;
            const isBanned = userData.isBanned || false;
            
            el.innerHTML = `<div style="background:#f8f9fa;padding:20px;border-radius:8px;">
                <h4 style="margin:0 0 15px 0;color:#212529;">ë‚´ ì •ë³´</h4>
                <p style="margin:8px 0;color:#495057;"><strong>ì´ë¦„:</strong> ${user.displayName || 'ë¯¸ì„¤ì •'}${isVIP ? ' <span class="vip-badge">â­ VIP</span>' : ''}</p>
                <p style="margin:8px 0;color:#495057;"><strong>ì´ë©”ì¼:</strong> ${user.email}</p>
                <p style="margin:8px 0;color:#c62828;"><strong>âš  ëˆ„ì  ê²½ê³ :</strong> ${warningCount}íšŒ ${isBanned ? '(ì°¨ë‹¨ë¨)' : ''}</p>
                ${hasChangedNickname ? 
                    '<p style="margin:8px 0;color:#868e96;font-size:13px;">ë‹‰ë„¤ì„ ë³€ê²½ ê¸°íšŒë¥¼ ì´ë¯¸ ì‚¬ìš©í•˜ì…¨ìŠµë‹ˆë‹¤.</p>' : 
                    '<button onclick="changeNickname()" class="btn btn-primary" style="width:100%;margin-top:15px;">ë‹‰ë„¤ì„ ë³€ê²½í•˜ê¸° (1íšŒ ê°€ëŠ¥)</button>'
                }
            </div>`;
        } else {
            el.innerHTML = `<div style="background:#f8f9fa;padding:20px;border-radius:8px;text-align:center;">
                <p style="color:#868e96;">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
            </div>`;
        }
    }
    
    const adminIndicator = document.getElementById("adminModeIndicator");
    if(adminIndicator) {
        if(isAdmin()) {
            adminIndicator.innerHTML = `
                <div style="background:#fff3cd;border:2px solid #856404;padding:20px;border-radius:8px;margin-bottom:30px;">
                    <h4 style="margin:0 0 15px 0;color:#856404;">ğŸ›¡ï¸ ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”</h4>
                    <p style="margin:0 0 15px 0;color:#856404;font-size:14px;">í˜„ì¬ ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ë¡œê·¸ì¸ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>
                    <button onclick="disableAdminMode()" class="btn btn-dark" style="width:100%;">ê´€ë¦¬ì ëª¨ë“œ í•´ì œ</button>
                </div>
            `;
        } else {
            adminIndicator.innerHTML = '';
        }
    }
}

async function changeNickname() {
    const user = auth.currentUser;
    if(!user) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!");
    
    const nicknameChangeSnapshot = await db.ref("users/" + user.uid + "/nicknameChanged").once("value");
    const hasChangedNickname = nicknameChangeSnapshot.val() || false;
    
    if(hasChangedNickname) {
        return alert("ë‹‰ë„¤ì„ì€ 1ë²ˆë§Œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¯¸ ë³€ê²½ ê¸°íšŒë¥¼ ì‚¬ìš©í•˜ì…¨ìŠµë‹ˆë‹¤.");
    }
    
    const currentNickname = getNickname();
    const newNickname = prompt(`í˜„ì¬ ë‹‰ë„¤ì„: ${currentNickname}\n\nìƒˆë¡œìš´ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš” (2-20ì):`);
    
    if(!newNickname) return;
    
    const trimmed = newNickname.trim();
    if(trimmed.length < 2 || trimmed.length > 20) {
        return alert("ë‹‰ë„¤ì„ì€ 2ì ì´ìƒ 20ì ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤!");
    }
    
    if(trimmed === currentNickname) {
        return alert("í˜„ì¬ ë‹‰ë„¤ì„ê³¼ ë™ì¼í•©ë‹ˆë‹¤!");
    }
    
    const foundWord = checkBannedWords(trimmed);
    if (foundWord) {
        alert("ê¸ˆì§€ì–´ê°€ í¬í•¨ëœ ë‹‰ë„¤ì„ì€ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }
    
    if(!confirm(`ì •ë§ ë‹‰ë„¤ì„ì„ "${trimmed}"ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ë‹‰ë„¤ì„ì€ 1ë²ˆë§Œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!`)) {
        return;
    }
    
    try {
        await user.updateProfile({
            displayName: trimmed
        });
        
        await db.ref("users/" + user.uid).update({
            nicknameChanged: true,
            newNickname: trimmed,
            oldNickname: currentNickname,
            changedAt: new Date().toLocaleString()
        });
        
        await updateUserContentNickname(currentNickname, trimmed, user.email);
        
        alert("ë‹‰ë„¤ì„ì´ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!");
        location.reload();
    } catch(error) {
        alert("ë‹‰ë„¤ì„ ë³€ê²½ ì‹¤íŒ¨: " + error.message);
        console.error(error);
    }
}

async function updateUserContentNickname(oldNickname, newNickname, userEmail) {
    const articlesSnapshot = await db.ref("articles").once("value");
    const articlesData = articlesSnapshot.val() || {};
    
    const updates = {};
    Object.entries(articlesData).forEach(([id, article]) => {
        if(article.author === oldNickname && article.authorEmail === userEmail) {
            updates[`articles/${id}/author`] = newNickname;
        }
    });
    
    const commentsSnapshot = await db.ref("comments").once("value");
    const commentsData = commentsSnapshot.val() || {};
    
    Object.entries(commentsData).forEach(([articleId, articleComments]) => {
        Object.entries(articleComments).forEach(([commentId, comment]) => {
            if(comment.author === oldNickname && comment.authorEmail === userEmail) {
                updates[`comments/${articleId}/${commentId}/author`] = newNickname;
            }
        });
    });
    
    if(Object.keys(updates).length > 0) {
        await db.ref().update(updates);
    }
}

function googleLogin() {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).then(() => {
        alert("êµ¬ê¸€ ë¡œê·¸ì¸ ì„±ê³µ!");
        location.reload();
    }).catch((error) => {
        console.error("ë¡œê·¸ì¸ ì˜¤ë¥˜:", error);
        alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message);
    });
}

function openAdminAuthModal(){
    document.getElementById("adminAuthModal").classList.add("active");
}
function closeAdminAuthModal(){
    document.getElementById("adminAuthModal").classList.remove("active");
}
function logoutAdmin(){
    if(!confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    auth.signOut();
    deleteCookie("is_admin");
    alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
    location.reload();
}

function disableAdminMode() {
    if(!confirm("ê´€ë¦¬ì ëª¨ë“œë¥¼ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì¼ë°˜ ì‚¬ìš©ì ëª¨ë“œë¡œ ì „í™˜ë©ë‹ˆë‹¤.")) return;
    deleteCookie("is_admin");
    alert("ê´€ë¦¬ì ëª¨ë“œê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
    location.reload();
}

const adminForm = document.getElementById("adminAuthForm");
if(adminForm) {
    adminForm.addEventListener("submit", async e=>{
        e.preventDefault();
        const email=document.getElementById("adminEmail").value;
        const pw=document.getElementById("adminPw").value;
        try{
            await auth.signInWithEmailAndPassword(email,pw);
            setCookie("is_admin","true");
            alert("ê´€ë¦¬ì ë¡œê·¸ì¸ ì„±ê³µ!");
            closeAdminAuthModal();
            location.reload();
        }catch(err){
            alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: "+err.message);
        }
    });
}

auth.onAuthStateChanged(async user=>{
    if (user) {
        const snap = await db.ref("users/" + user.uid).once("value");
        const data = snap.val() || {};
        if (data.isBanned) {
            alert("ğŸš« ì°¨ë‹¨ëœ ê³„ì •ì…ë‹ˆë‹¤.\nê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
            auth.signOut();
            return;
        }
    }

    updateSettings();
    
    const adminEventTab = document.getElementById("adminEventTab");
    if(adminEventTab) {
        if(user) {
            db.ref("users/" + user.uid + "/isVIP").once("value").then(snapshot => {
                const isVIP = snapshot.val() || false;
                if(isAdmin() || isVIP) {
                    adminEventTab.style.display = "block";
                } else {
                    adminEventTab.style.display = "none";
                }
            });
        } else {
            adminEventTab.style.display = "none";
        }
    }
    
    updateHeaderAuthButton();
    
    if(document.querySelector(".articles-section.active")) {
        filteredArticles = allArticles;
        renderArticles();
    }
});

function updateHeaderAuthButton() {
    const headerAuthButton = document.getElementById("headerAuthButton");
    if(!headerAuthButton) return;
    
    const user = auth.currentUser;
    if(user) {
        const nickname = getNickname();
        headerAuthButton.innerHTML = `
            <div style="display:flex;align-items:center;gap:12px;">
                <span style="color:#495057;font-weight:600;font-size:14px;">ğŸ‘¤ ${nickname}${isAdmin() ? ' <span style="color:#c62828;">(ê´€ë¦¬ì)</span>' : ''}</span>
                <button class="btn btn-gray" onclick="logoutAdmin()" style="height:40px;padding:0 20px;">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        `;
    } else {
        headerAuthButton.innerHTML = `
            <button class="btn btn-secondary" onclick="googleLogin()">ğŸ”“ ë¡œê·¸ì¸</button>
        `;
    }
}

// ===== Part 3: ì‚¬ìš©ì ê´€ë¦¬ ë° ê´€ë¦¬ì ì´ë²¤íŠ¸ =====

async function showUserManagement(){
    if(!isAdmin()) return alert("ê´€ë¦¬ì ê¶Œí•œ í•„ìš”!");
    hideAll();
    document.getElementById("userManagementSection").classList.add("active");
    const root=document.getElementById("usersList");
    root.innerHTML = "<p style='text-align:center;color:#868e96;'>ì‚¬ìš©ì ì •ë³´ ë¡œë”© ì¤‘...</p>";
    try {
        const articlesSnapshot = await db.ref("articles").once("value");
        const articlesData = articlesSnapshot.val() || {};
        const articles = Object.values(articlesData);
        
        const commentsSnapshot = await db.ref("comments").once("value");
        const commentsData = commentsSnapshot.val() || {};
        const usersMap = new Map();
        
        articles.forEach(article => {
            if(article.author && article.author !== "ìµëª…" && article.authorEmail) {
                if(!usersMap.has(article.authorEmail)) {
                    usersMap.set(article.authorEmail, {
                        nickname: article.author,
                        email: article.authorEmail,
                        articles: [],
                        comments: [],
                        lastActivity: article.date
                    });
                }
                usersMap.get(article.authorEmail).articles.push(article);
            }
        });
        
        Object.entries(commentsData).forEach(([articleId, articleComments]) => {
            Object.entries(articleComments).forEach(([commentId, comment]) => {
                if(comment.author && comment.author !== "ìµëª…" && comment.authorEmail) {
                    if(!usersMap.has(comment.authorEmail)) {
                        usersMap.set(comment.authorEmail, {
                            nickname: comment.author,
                            email: comment.authorEmail,
                            articles: [],
                            comments: [],
                            lastActivity: comment.timestamp
                        });
                    }
                    usersMap.get(comment.authorEmail).comments.push({...comment,articleId,commentId});
                    usersMap.get(comment.authorEmail).lastActivity = comment.timestamp;
                }
            });
        });
        
        const currentUserEmail = getUserEmail();
        const currentNickname = getNickname();
        if(currentUserEmail && currentNickname !== "ìµëª…" && !usersMap.has(currentUserEmail)) {
            usersMap.set(currentUserEmail, {
                nickname: currentNickname,
                email: currentUserEmail,
                articles: [],
                comments: [],
                lastActivity: new Date().toLocaleString()
            });
        }
        
        const usersSnapshot = await db.ref("users").once("value");
        const usersData = usersSnapshot.val() || {};
        
        if(usersMap.size === 0) {
            root.innerHTML = "<p style='text-align:center;color:#868e96;'>ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
            return;
        }
        
        const usersList = Array.from(usersMap.values());
        
        root.innerHTML = usersList.map(u => {
            let userData = null;
            let uid = null;
            for (const [key, val] of Object.entries(usersData)) {
                if (val.email === u.email) {
                    userData = val;
                    uid = key;
                    break;
                }
            }
            const isVIP = userData ? (userData.isVIP || false) : false;
            const warningCount = userData ? (userData.warningCount || 0) : 0;
            const isBanned = userData ? (userData.isBanned || false) : false;
            const safeUid = uid || 'email_' + btoa(u.email).replace(/=/g, '');

            return `
            <div style="background:#f8f9fa;padding:20px;border-radius:8px;margin-bottom:15px;border-left:4px solid ${isBanned ? '#343a40' : (isVIP ? '#ffd700' : '#c62828')}; opacity: ${isBanned ? '0.7' : '1'};">
                <h4 style="margin:0 0 15px 0;color:${isBanned ? '#343a40' : (isVIP ? '#ffd700' : '#c62828')};">
                    ğŸ‘¤ ${u.nickname}${isVIP ? ' <span class="vip-badge">â­ VIP</span>' : ''}
                    ${isBanned ? ' <span style="background:#343a40;color:#fff;padding:2px 8px;border-radius:10px;font-size:12px;">ğŸš« ì°¨ë‹¨ë¨</span>' : ''}
                </h4>
                <div style="color:#495057;font-size:14px;margin-bottom:15px;line-height:1.8;">
                    ğŸ“§ ì´ë©”ì¼: <strong>${u.email}</strong><br>
                    ğŸ“° ê¸°ì‚¬: <strong>${u.articles.length}</strong> | ğŸ’¬ ëŒ“ê¸€: <strong>${u.comments.length}</strong><br>
                    âš  ëˆ„ì  ê²½ê³ : <strong>${warningCount}íšŒ</strong><br>
                    ğŸ• ë§ˆì§€ë§‰ í™œë™: ${u.lastActivity}
                </div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    <button onclick="showUserDetail('${u.nickname}')" class="btn btn-blue" style="font-size:12px;">ìƒì„¸</button>
                    
                    ${isVIP ? 
                        `<button onclick="toggleVIPStatus('${u.email}', false)" class="btn btn-gray" style="font-size:12px;">VIPí•´ì œ</button>` :
                        `<button onclick="toggleVIPStatus('${u.email}', true)" class="btn btn-primary" style="font-size:12px;">VIPìŠ¹ê¸‰</button>`
                    }
                    
                    <button onclick="changeWarning('${safeUid}', '${u.email}', 1)" class="btn btn-warning" style="font-size:12px;">ê²½ê³ +1</button>
                    <button onclick="changeWarning('${safeUid}', '${u.email}', -1)" class="btn btn-gray" style="font-size:12px;">ê²½ê³ -1</button>

                    ${isBanned ?
                        `<button onclick="toggleBan('${safeUid}', '${u.email}', false)" class="btn btn-green" style="font-size:12px;">ì°¨ë‹¨í•´ì œ</button>` :
                        `<button onclick="toggleBan('${safeUid}', '${u.email}', true)" class="btn btn-dark" style="font-size:12px;">ì°¨ë‹¨í•˜ê¸°</button>`
                    }

                    <button onclick="deleteUserCompletely('${u.nickname}')" class="btn btn-gray" style="font-size:12px;">ì‚­ì œ</button>
                </div>
            </div>
        `}).join('');
    } catch(error) {
        root.innerHTML = `<p style="color:#dc3545;text-align:center;">ì˜¤ë¥˜: ${error.message}</p>`;
    }
}

async function changeWarning(uid, email, amount) {
    if(!isAdmin()) return;
    if(uid.startsWith('email_')) await db.ref("users/" + uid).update({ email: email });

    const snap = await db.ref("users/" + uid).once("value");
    const data = snap.val() || {};
    let current = data.warningCount || 0;
    
    let nextVal = current + amount;
    if (nextVal < 0) nextVal = 0;
    
    let updates = { warningCount: nextVal, email: email }; 
    if (nextVal >= 3 && !data.isBanned) {
        updates.isBanned = true;
        alert("ğŸš¨ ëˆ„ì  ê²½ê³  3íšŒ ë„ë‹¬ë¡œ ì¸í•´ ì°¨ë‹¨ë©ë‹ˆë‹¤.");
    }

    await db.ref("users/" + uid).update(updates);
    showUserManagement();
}

async function toggleBan(uid, email, shouldBan) {
    if(!isAdmin()) return;
    const action = shouldBan ? "ì°¨ë‹¨" : "ì°¨ë‹¨ í•´ì œ";
    if(!confirm(`ì •ë§ ì´ ì‚¬ìš©ìë¥¼ ${action}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    if(uid.startsWith('email_')) await db.ref("users/" + uid).update({ email: email });

    await db.ref("users/" + uid).update({
        isBanned: shouldBan,
        email: email
    });
    
    alert(`${action} ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
    showUserManagement();
}

async function toggleVIPStatus(userEmail, makeVIP) {
    if(!isAdmin()) return alert("ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤!");
    const action = makeVIP ? "VIPë¡œ ìŠ¹ê¸‰" : "VIP ì·¨ì†Œ";
    if(!confirm(`"${userEmail}" ì‚¬ìš©ìë¥¼ ${action}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    
    try {
        const usersSnapshot = await db.ref("users").once("value");
        const usersData = usersSnapshot.val() || {};
        let targetUid = null;
        Object.entries(usersData).forEach(([uid, userData]) => {
            if(userData.email === userEmail) targetUid = uid;
        });
        
        const currentUser = auth.currentUser;
        if(currentUser && currentUser.email === userEmail) targetUid = currentUser.uid;
        if(!targetUid) targetUid = 'email_' + btoa(userEmail).replace(/=/g, '');
        
        await db.ref("users/" + targetUid).update({
            email: userEmail,
            isVIP: makeVIP,
            vipUpdatedAt: new Date().toLocaleString(),
            vipUpdatedBy: getNickname()
        });
        alert(`${action}ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!`);
        showUserManagement();
    } catch(error) {
        alert("ì˜¤ë¥˜: " + error.message);
    }
}

async function showUserDetail(nickname) {
    const articlesSnapshot = await db.ref("articles").once("value");
    const articlesData = articlesSnapshot.val() || {};
    const articles = Object.values(articlesData).filter(a => a.author === nickname);
    
    const commentsSnapshot = await db.ref("comments").once("value");
    const commentsData = commentsSnapshot.val() || {};
    const userComments = [];
    
    Object.entries(commentsData).forEach(([articleId, articleComments]) => {
        Object.entries(articleComments).forEach(([commentId, comment]) => {
            if(comment.author === nickname) {
                userComments.push({...comment,articleId,commentId});
            }
        });
    });
    
    let userEmail = "ë¯¸í™•ì¸";
    let userId = null;
    if(articles.length > 0 && articles[0].authorEmail) userEmail = articles[0].authorEmail;
    else if(userComments.length > 0 && userComments[0].authorEmail) userEmail = userComments[0].authorEmail;
    
    if(userEmail !== "ë¯¸í™•ì¸") {
        const usersSnapshot = await db.ref("users").once("value");
        const usersData = usersSnapshot.val() || {};
        Object.entries(usersData).forEach(([uid, userData]) => {
            if(userData.email === userEmail) userId = uid;
        });
    }
    
    const modal = document.getElementById("userDetailModal");
    const content = document.getElementById("userDetailContent");
    content.innerHTML = `
        <h3 style="margin-top:0;color:#c62828;font-size:24px;">ğŸ‘¤ ${nickname}</h3>
        <p>Email: ${userEmail}</p>
        <div style="margin-top:25px;">
            <h4 style="color:#1976d2;">ğŸ“° ì‘ì„± ê¸°ì‚¬ (${articles.length}ê°œ)</h4>
            ${articles.map(a => `
                <div style="background:#f8f9fa;padding:10px;margin-bottom:5px;border-left:3px solid #c62828;">
                    ${a.title}
                    <button onclick="deleteArticleFromAdmin('${a.id}', '${nickname}')" class="btn btn-gray" style="font-size:10px;float:right;">ì‚­ì œ</button>
                </div>`).join('')}
        </div>
        <div style="margin-top:20px;">
            <h4 style="color:#1976d2;">ğŸ’¬ ì‘ì„± ëŒ“ê¸€ (${userComments.length}ê°œ)</h4>
            ${userComments.map(c => `
                <div style="background:#f8f9fa;padding:10px;margin-bottom:5px;border-left:3px solid #6c757d;">
                    ${c.text}
                    <button onclick="deleteCommentFromAdmin('${c.articleId}', '${c.commentId}', '${nickname}')" class="btn btn-gray" style="font-size:10px;float:right;">ì‚­ì œ</button>
                </div>`).join('')}
        </div>
    `;
    modal.classList.add("active");
}

function adminChangeUserNickname(userId, currentNickname, userEmail) {
    if(!isAdmin()) return alert("ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤!");
    const newNickname = prompt(`ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ë‹‰ë„¤ì„ ë³€ê²½\ní˜„ì¬: ${currentNickname}`);
    if(!newNickname) return;
    
    db.ref("users/" + userId).update({
        adminChangedNickname: true,
        newNickname: newNickname.trim(),
        oldNickname: currentNickname
    }).then(() => {
        updateUserContentNickname(currentNickname, newNickname.trim(), userEmail);
        alert("ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
        closeUserDetail();
        showUserManagement();
    });
}

function closeUserDetail() {
    document.getElementById("userDetailModal").classList.remove("active");
}
function deleteArticleFromAdmin(id, nickname) {
    if(!confirm("ì´ ê¸°ì‚¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    deleteArticleFromDB(id, () => {
        db.ref("comments/" + id).remove();
        alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        closeUserDetail();
        showUserDetail(nickname);
    });
}
function editCommentFromAdmin(articleId, commentId) {
    // ê¸°ëŠ¥ ìƒëµ (ê¸°ì¡´ ìœ ì§€)
}
function deleteCommentFromAdmin(articleId, commentId, nickname) {
    if(!confirm("ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    db.ref("comments/" + articleId + "/" + commentId).remove().then(() => {
        alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        closeUserDetail();
        showUserDetail(nickname);
    });
}

function deleteUserCompletely(nick){
    if(!confirm(`"${nick}" ì‚¬ìš©ìë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    
    db.ref("articles").once("value").then(snapshot => {
        const articlesData = snapshot.val() || {};
        Object.entries(articlesData).forEach(([id, article]) => {
            if(article.author === nick) {
                db.ref("articles/" + id).remove();
            }
        });
    });
    
    db.ref("comments").once("value").then(s=>{
        const val=s.val()||{};
        Object.entries(val).forEach(([aid,group])=>{
            Object.entries(group).forEach(([cid,c])=>{
                if(c.author===nick)
                    db.ref("comments/"+aid+"/"+cid).remove();
            });
        });
    });
    
    alert(`"${nick}" ì‚¬ìš©ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
    showUserManagement();
}

// ===== ê´€ë¦¬ì ì´ë²¤íŠ¸ ê¸°ëŠ¥ =====

async function showAdminEvent() {
    const user = auth.currentUser;
    if(!user) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!");

    const vipSnapshot = await db.ref("users/" + user.uid + "/isVIP").once("value");
    const isVIP = vipSnapshot.val() || false;

    if(!isAdmin() && !isVIP) {
        return alert("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤ (VIP ë˜ëŠ” ê´€ë¦¬ì ì „ìš©).");
    }
    
    hideAll();
    document.querySelector(".admin-event-section").classList.add("active");
    const navItems = document.querySelectorAll(".nav-item");
    if(navItems[3]) navItems[3].classList.add("active");

    document.getElementById("eventContent").innerHTML = `
        <div style="text-align:center;padding:60px 20px;color:#868e96;">
            <p style="font-size:18px;margin-bottom:10px;">ì›í•˜ëŠ” ê¸°ëŠ¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”</p>
        </div>
    `;
}

// ê¸ˆì§€ì–´ ê´€ë¦¬ ëª¨ë‹¬ ì—´ê¸°
function showBannedWordManager() {
    const modal = document.getElementById("bannedWordsModal");
    const input = document.getElementById("bannedWordsInput");
    
    input.value = bannedWordsList.join(', '); // í˜„ì¬ ê¸ˆì§€ì–´ ëª©ë¡ í‘œì‹œ
    modal.classList.add("active");
}

function closeBannedWordsModal() {
    document.getElementById("bannedWordsModal").classList.remove("active");
}

function saveBannedWords() {
    const input = document.getElementById("bannedWordsInput").value;
    const newList = input.split(',').map(s => s.trim()).filter(s => s !== "");
    
    db.ref("adminSettings/bannedWords").set(newList.join(',')).then(() => {
        alert("ê¸ˆì§€ì–´ ëª©ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        closeBannedWordsModal();
    }).catch(err => alert("ì €ì¥ ì‹¤íŒ¨: " + err.message));
}

// ê¸°ì‚¬ ê³ ì • ê´€ë¦¬
async function showPinManager() {
    const content = document.getElementById("eventContent");
    content.innerHTML = "<p style='text-align:center;color:#868e96;'>ë¡œë”© ì¤‘...</p>";
    
    const articlesSnapshot = await db.ref("articles").once("value");
    const articlesData = articlesSnapshot.val() || {};
    const articles = Object.values(articlesData);
    
    const pinsSnapshot = await db.ref("pinnedArticles").once("value");
    const pinnedData = pinsSnapshot.val() || {};
    const pinnedArticles = Object.entries(pinnedData)
        .sort((a, b) => b[1].pinnedAt - a[1].pinnedAt)
        .map(([id, data]) => {
            const article = articles.find(a => a.id === id);
            return article ? {...article, pinnedAt: data.pinnedAt} : null;
        })
        .filter(a => a !== null);
    
    const unpinnedArticles = articles.filter(a => !pinnedData[a.id]);
    
    content.innerHTML = `
        <h3 style="color:#c62828;margin-bottom:20px;">ğŸ“Œ ê³ ì •ëœ ê¸°ì‚¬ (${pinnedArticles.length}ê°œ)</h3>
        ${pinnedArticles.length === 0 ? 
            '<p style="color:#868e96;padding:20px;text-align:center;background:#f8f9fa;border-radius:8px;margin-bottom:30px;">ê³ ì •ëœ ê¸°ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>' :
            pinnedArticles.map(a => `
                <div style="background:#fffbf0;border:2px solid #ffd700;padding:20px;border-radius:8px;margin-bottom:15px;position:relative;">
                    <div style="position:absolute;top:10px;right:10px;background:#ffd700;color:#000;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:700;">
                        ğŸ“Œ ê³ ì •ë¨
                    </div>
                    <h4 style="margin:0 0 10px 0;color:#212529;padding-right:80px;">${a.title}</h4>
                    <p style="margin:0 0 10px 0;color:#6c757d;font-size:13px;">${a.category} Â· ${a.author} Â· ${a.date}</p>
                    <p style="margin:0 0 15px 0;color:#495057;font-size:14px;">${a.summary || ''}</p>
                    <button onclick="unpinArticle('${a.id}')" class="btn btn-gray" style="height:36px;padding:0 16px;font-size:13px;">
                        ê³ ì • ì·¨ì†Œ
                    </button>
                </div>
            `).join('')
        }
        
        <h3 style="color:#495057;margin:40px 0 20px 0;">ğŸ“° ì „ì²´ ê¸°ì‚¬ ëª©ë¡</h3>
        ${unpinnedArticles.length === 0 ?
            '<p style="color:#868e96;padding:20px;text-align:center;background:#f8f9fa;border-radius:8px;">ê³ ì • ê°€ëŠ¥í•œ ê¸°ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>' :
            unpinnedArticles.map(a => `
                <div style="background:#f8f9fa;padding:20px;border-radius:8px;margin-bottom:15px;">
                    <h4 style="margin:0 0 10px 0;color:#212529;">${a.title}</h4>
                    <p style="margin:0 0 10px 0;color:#6c757d;font-size:13px;">${a.category} Â· ${a.author} Â· ${a.date}</p>
                    <p style="margin:0 0 15px 0;color:#495057;font-size:14px;">${a.summary || ''}</p>
                    <button onclick="pinArticle('${a.id}')" class="btn btn-primary" style="height:36px;padding:0 16px;font-size:13px;">
                        ğŸ“Œ ìƒë‹¨ ê³ ì •í•˜ê¸°
                    </button>
                </div>
            `).join('')
        }
    `;
}

async function pinArticle(articleId) {
    if(!confirm("ì´ ê¸°ì‚¬ë¥¼ ìµœìƒë‹¨ì— ê³ ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    
    try {
        await db.ref("pinnedArticles/" + articleId).set({
            pinnedAt: Date.now()
        });
        alert("ê¸°ì‚¬ê°€ ìƒë‹¨ì— ê³ ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
        showPinManager();
    } catch(error) {
        alert("ê³ ì • ì‹¤íŒ¨: " + error.message);
    }
}

async function unpinArticle(articleId) {
    if(!confirm("ì´ ê¸°ì‚¬ì˜ ê³ ì •ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    
    try {
        await db.ref("pinnedArticles/" + articleId).remove();
        alert("ê³ ì •ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤!");
        showPinManager();
    } catch(error) {
        alert("ì·¨ì†Œ ì‹¤íŒ¨: " + error.message);
    }
}

// ê´‘ê³  ê´€ë¦¬
async function showAdManager() {
    const content = document.getElementById("eventContent");
    content.innerHTML = "<p style='text-align:center;color:#868e96;'>ë¡œë”© ì¤‘...</p>";
    
    const adsSnapshot = await db.ref("advertisements").once("value");
    const adsData = adsSnapshot.val() || {};
    const ads = Object.entries(adsData)
        .sort((a, b) => b[1].createdAt - a[1].createdAt)
        .map(([id, data]) => ({id, ...data}));
    
    content.innerHTML = `
        <div style="margin-bottom:30px;">
            <button onclick="openAdCreateModal()" class="btn btn-primary" style="height:48px;width:100%;font-size:16px;">
                â• ìƒˆ ê´‘ê³  ë§Œë“¤ê¸°
            </button>
        </div>
        
        <h3 style="color:#1976d2;margin-bottom:20px;">ğŸ“¢ í™œì„± ê´‘ê³  ëª©ë¡ (${ads.length}ê°œ)</h3>
        ${ads.length === 0 ?
            '<p style="color:#868e96;padding:20px;text-align:center;background:#f8f9fa;border-radius:8px;">ë“±ë¡ëœ ê´‘ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.</p>' :
            ads.map(ad => `
                <div style="background:${ad.color};border-left:4px solid #1976d2;padding:20px;border-radius:8px;margin-bottom:15px;">
                    <h4 style="margin:0 0 10px 0;color:#212529;">${ad.title}</h4>
                    <p style="margin:0 0 10px 0;color:#495057;white-space:pre-wrap;">${ad.content}</p>
                    ${ad.link ? `<p style="margin:0 0 10px 0;"><a href="${ad.link}" target="_blank" style="color:#1976d2;">ğŸ”— ${ad.link}</a></p>` : ''}
                    <p style="margin:0 0 15px 0;color:#6c757d;font-size:12px;">ìƒì„±ì¼: ${new Date(ad.createdAt).toLocaleString()}</p>
                    <button onclick="deleteAd('${ad.id}')" class="btn btn-gray" style="height:36px;padding:0 16px;font-size:13px;">
                        ì‚­ì œ
                    </button>
                </div>
            `).join('')
        }
    `;
}

function openAdCreateModal() {
    document.getElementById("adCreateModal").classList.add("active");
}

function closeAdCreateModal() {
    document.getElementById("adCreateModal").classList.remove("active");
    document.getElementById("adCreateForm").reset();
}

const adCreateForm = document.getElementById("adCreateForm");
if(adCreateForm) {
    adCreateForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        
        const ad = {
            id: Date.now().toString(),
            title: document.getElementById("adTitle").value,
            content: document.getElementById("adContent").value,
            link: document.getElementById("adLink").value,
            color: document.getElementById("adColor").value,
            createdAt: Date.now()
        };
        
        try {
            await db.ref("advertisements/" + ad.id).set(ad);
            alert("ê´‘ê³ ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!");
            closeAdCreateModal();
            showAdManager();
        } catch(error) {
            alert("ê´‘ê³  ìƒì„± ì‹¤íŒ¨: " + error.message);
        }
    });
}

async function deleteAd(adId) {
    if(!confirm("ì´ ê´‘ê³ ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    
    try {
        await db.ref("advertisements/" + adId).remove();
        alert("ê´‘ê³ ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!");
        showAdManager();
    } catch(error) {
        alert("ì‚­ì œ ì‹¤íŒ¨: " + error.message);
    }
}

// ì´ˆê¸°í™”
window.addEventListener("load", () => {
    setupArticlesListener();
    
    const form = document.getElementById("articleForm");
    if(form) {
        const fileInput = form.querySelector('#thumbnailInput');
        if(fileInput) {
            fileInput.addEventListener('change', previewThumbnail);
        }
        
        form.addEventListener("submit", function(e) {
            e.preventDefault();
            if(!isLoggedIn()) {
                alert("ê¸°ì‚¬ ì‘ì„±ì€ ë¡œê·¸ì¸ í›„ ê°€ëŠ¥í•©ë‹ˆë‹¤!");
                return;
            }
            
            const fileInput = form.querySelector('#thumbnailInput');
            const A = {
                id: Date.now().toString(),
                category: form.querySelector("#category").value,
                title: form.querySelector("#title").value,
                summary: form.querySelector("#summary").value,
                content: form.querySelector("#content").value,
                author: getNickname(),
                authorEmail: getUserEmail(),
                date: new Date().toLocaleString(),
                createdAt: Date.now(),
                views: 0,
                likeCount: 0,
                dislikeCount: 0,
                thumbnail: null
            };
            
            if(fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    A.thumbnail = e.target.result;
                    saveNewArticle(A);
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                saveNewArticle(A);
            }
            
            function saveNewArticle(article) {
                saveArticle(article, () => {
                    form.reset();
                    document.getElementById('thumbnailPreview').style.display = 'none';
                    document.getElementById('uploadText').textContent = 'ğŸ“· í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì„ íƒì‚¬í•­)';
                    alert("ê¸°ì‚¬ê°€ ë°œí–‰ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    showArticles();
                });
            }
        });
    }
});
function openAdCreateModal() { document.getElementById("adCreateModal").classList.add("active"); }
function closeAdCreateModal() { document.getElementById("adCreateModal").classList.remove("active"); document.getElementById("adCreateForm").reset(); }
async function deleteAd(adId) { /* ê¸°ì¡´ ì½”ë“œ ìœ ì§€ */ }

// ì´ˆê¸°í™”
window.addEventListener("load", () => {
    setupArticlesListener();
    loadBannedWords(); // ê¸ˆì§€ì–´ ë¡œë“œ
    restoreFormDefaultBehavior(); // í¼ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
});
