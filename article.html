<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>기사 - TODAY NEWS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        /* 헤더 */
        header {
            background-color: #fff;
            border-bottom: 1px solid #e0e0e0;
            padding: 15px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .header-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: 800;
            color: #d32f2f;
            text-decoration: none;
        }

        .btn-back {
            padding: 8px 15px;
            background-color: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-back:hover {
            background-color: #e0e0e0;
        }

        /* 메인 콘텐츠 */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* 기사 헤더 */
        .article-header {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .article-title {
            font-size: 32px;
            font-weight: 700;
            line-height: 1.4;
            margin-bottom: 20px;
        }

        .article-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .author-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .author-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #d32f2f;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .author-details {
            display: flex;
            flex-direction: column;
        }

        .author-name {
            font-weight: 600;
            color: #333;
        }

        .article-date {
            font-size: 13px;
            color: #999;
        }

        .article-actions {
            display: flex;
            gap: 10px;
        }

        .btn-edit, .btn-delete {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.3s;
        }

        .btn-edit {
            background-color: #2196F3;
            color: white;
        }

        .btn-edit:hover {
            background-color: #1976D2;
        }

        .btn-delete {
            background-color: #d32f2f;
            color: white;
        }

        .btn-delete:hover {
            background-color: #b71c1c;
        }

        /* 기사 이미지 */
        .article-image {
            width: 100%;
            max-height: 500px;
            border-radius: 8px;
            object-fit: cover;
            margin-bottom: 30px;
        }

        /* 기사 내용 */
        .article-content {
            font-size: 16px;
            line-height: 1.8;
            margin-bottom: 40px;
            color: #333;
        }

        .article-content p {
            margin-bottom: 15px;
        }

        .article-content h2 {
            font-size: 24px;
            font-weight: 700;
            margin: 30px 0 15px 0;
        }

        .article-content h3 {
            font-size: 20px;
            font-weight: 700;
            margin: 25px 0 12px 0;
        }

        .article-content ul, .article-content ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .article-content li {
            margin-bottom: 8px;
        }

        .article-content hr {
            margin: 30px 0;
            border: none;
            border-top: 1px solid #e0e0e0;
        }

        /* 카테고리와 태그 */
        .article-tags {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tag {
            display: inline-block;
            padding: 6px 12px;
            background-color: #f0f0f0;
            border-radius: 20px;
            font-size: 13px;
            color: #666;
        }

        .tag.category {
            background-color: #d32f2f;
            color: white;
        }

        /* 댓글 섹션 */
        .comments-section {
            margin-top: 40px;
        }

        .comments-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .comments-count {
            font-size: 14px;
            color: #999;
            margin-left: 10px;
        }

        /* 댓글 작성 */
        .comment-write {
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .comment-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .comment-write textarea {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
        }

        .comment-write textarea:focus {
            outline: none;
            border-color: #d32f2f;
        }

        .comment-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .btn-comment-submit, .btn-comment-cancel {
            padding: 8px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-comment-submit {
            background-color: #d32f2f;
            color: white;
        }

        .btn-comment-submit:hover {
            background-color: #b71c1c;
        }

        .btn-comment-cancel {
            background-color: #e0e0e0;
            color: #333;
        }

        .btn-comment-cancel:hover {
            background-color: #d0d0d0;
        }

        /* 댓글 목록 */
        .comments-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .comment-item {
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 15px;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .comment-author-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .comment-author {
            font-weight: 600;
            color: #333;
        }

        .comment-date {
            font-size: 12px;
            color: #999;
        }

        .comment-delete-btn {
            padding: 4px 10px;
            background-color: #d32f2f;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s;
        }

        .comment-delete-btn:hover {
            background-color: #b71c1c;
        }

        .comment-content {
            font-size: 14px;
            line-height: 1.6;
            color: #555;
            word-break: break-word;
        }

        /* 더보기 댓글 */
        .load-more-comments {
            text-align: center;
            margin-top: 15px;
        }

        .btn-load-more-comments {
            padding: 8px 25px;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            color: #333;
            transition: all 0.3s;
        }

        .btn-load-more-comments:hover {
            background-color: #e0e0e0;
        }

        .no-comments {
            text-align: center;
            padding: 30px;
            color: #999;
        }

        @media (max-width: 768px) {
            .article-title {
                font-size: 24px;
            }

            .article-meta {
                flex-direction: column;
                align-items: flex-start;
            }

            .comment-input-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- 헤더 -->
    <header>
        <div class="header-container">
            <a href="index.html" class="logo">TODAY NEWS</a>
            <a href="index.html" class="btn-back">← 돌아가기</a>
        </div>
    </header>

    <!-- 메인 콘텐츠 -->
    <div class="container">
        <!-- 기사 -->
        <article id="articleContainer"></article>

        <!-- 댓글 섹션 -->
        <section class="comments-section">
            <h2 class="comments-title">
                댓글
                <span class="comments-count" id="commentsCount">(0)</span>
            </h2>

            <!-- 댓글 작성 -->
            <div class="comment-write" id="commentWrite">
                <textarea id="commentInput" placeholder="댓글을 입력하세요..."></textarea>
                <div class="comment-actions">
                    <button class="btn-comment-cancel" onclick="cancelComment()">취소</button>
                    <button class="btn-comment-submit" onclick="submitComment()">댓글 작성</button>
                </div>
            </div>

            <!-- 댓글 목록 -->
            <div class="comments-list" id="commentsList">
                <div class="no-comments">아직 댓글이 없습니다. 첫 번째 댓글을 남겨보세요!</div>
            </div>

            <!-- 더보기 댓글 -->
            <div class="load-more-comments" id="loadMoreCommentsContainer" style="display: none;">
                <button class="btn-load-more-comments" onclick="loadMoreComments()">더보기...</button>
            </div>
        </section>
    </div>

    <script>
        let currentUser = null;
        let currentArticle = null;
        let allComments = [];
        let displayedComments = 3;
        const COMMENTS_PER_PAGE = 3;

        // 초기화
        window.addEventListener('load', () => {
            initUser();
            loadArticle();
        });

        // 사용자 초기화
        function initUser() {
            const saved = localStorage.getItem('userNickname');
            if (saved) {
                currentUser = { nickname: saved };
            }
        }

        // 기사 로드
        function loadArticle() {
            const params = new URLSearchParams(window.location.search);
            const articleId = params.get('id');

            if (!articleId) {
                document.getElementById('articleContainer').innerHTML = '<p>기사를 찾을 수 없습니다.</p>';
                return;
            }

            const articles = JSON.parse(localStorage.getItem('articles') || '[]');
            currentArticle = articles.find(a => a.id === articleId);

            if (!currentArticle) {
                document.getElementById('articleContainer').innerHTML = '<p>기사를 찾을 수 없습니다.</p>';
                return;
            }

            renderArticle();
            loadComments();
        }

        // 기사 렌더링
        function renderArticle() {
            const isAuthor = currentUser && currentUser.nickname === currentArticle.author;

            let actionsHtml = '';
            if (isAuthor) {
                actionsHtml = `
                    <div class="article-actions">
                        <button class="btn-edit" onclick="editArticle()">수정</button>
                        <button class="btn-delete" onclick="deleteArticle()">삭제</button>
                    </div>
                `;
            }

            const contentWithFormatting = currentArticle.content
                .split('\n')
                .map(line => {
                    if (!line.trim()) return '</p><p>';
                    return line;
                })
                .join('');

            let tagsHtml = '';
            if (currentArticle.category) {
                tagsHtml += `<span class="tag category">${currentArticle.category}</span>`;
            }
            if (currentArticle.tags) {
                const tags = currentArticle.tags.split(',').map(t => t.trim()).filter(t => t);
                tags.forEach(tag => {
                    tagsHtml += `<span class="tag">${tag}</span>`;
                });
            }

            const html = `
                <div class="article-header">
                    <h1 class="article-title">${escapeHtml(currentArticle.title)}</h1>
                    <div class="article-meta">
                        <div class="author-info">
                            <div class="author-avatar">${currentArticle.author.charAt(0).toUpperCase()}</div>
                            <div class="author-details">
                                <div class="author-name">${escapeHtml(currentArticle.author)}</div>
                                <div class="article-date">${formatDate(currentArticle.createdAt)}</div>
                            </div>
                        </div>
                        ${actionsHtml}
                    </div>
                </div>

                ${currentArticle.image ? `<img src="${currentArticle.image}" alt="기사 이미지" class="article-image">` : ''}

                <div class="article-content"><p>${contentWithFormatting}</p></div>

                ${tagsHtml ? `<div class="article-tags">${tagsHtml}</div>` : ''}
            `;

            document.getElementById('articleContainer').innerHTML = html;
        }

        // 기사 수정
        function editArticle() {
            window.location.href = `write.html?edit=${currentArticle.id}`;
        }

        // 기사 삭제
        function deleteArticle() {
            if (!confirm('정말 이 기사를 삭제하시겠습니까?')) return;

            const articles = JSON.parse(localStorage.getItem('articles') || '[]');
            const filtered = articles.filter(a => a.id !== currentArticle.id);
            localStorage.setItem('articles', JSON.stringify(filtered));

            // 해당 기사의 댓글도 삭제
            let commentsData = JSON.parse(localStorage.getItem('comments') || '{}');
            delete commentsData[currentArticle.id];
            localStorage.setItem('comments', JSON.stringify(commentsData));

            alert('기사가 삭제되었습니다');
            window.location.href = 'index.html';
        }

        // 댓글 로드
        function loadComments() {
            const commentsData = JSON.parse(localStorage.getItem('comments') || '{}');
            allComments = commentsData[currentArticle.id] || [];
            allComments.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
            displayedComments = COMMENTS_PER_PAGE;
            renderComments();
        }

        // 댓글 렌더링
        function renderComments() {
            const container = document.getElementById('commentsList');
            
            document.getElementById('commentsCount').textContent = `(${allComments.length})`;

            if (allComments.length === 0) {
                container.innerHTML = '<div class="no-comments">아직 댓글이 없습니다. 첫 번째 댓글을 남겨보세요!</div>';
                document.getElementById('loadMoreCommentsContainer').style.display = 'none';
                return;
            }

            const displayed = allComments.slice(0, displayedComments);
            container.innerHTML = displayed.map(comment => {
                const isAuthor = currentUser && currentUser.nickname === comment.author;
                return `
                    <div class="comment-item">
                        <div class="comment-header">
                            <div class="comment-author-info">
                                <span class="comment-author">${escapeHtml(comment.author)}</span>
                                <span class="comment-date">${formatDate(comment.createdAt)}</span>
                            </div>
                            ${isAuthor ? `<button class="comment-delete-btn" onclick="deleteComment('${comment.id}')">삭제</button>` : ''}
                        </div>
                        <div class="comment-content">${escapeHtml(comment.content).replace(/\n/g, '<br>')}</div>
                    </div>
                `;
            }).join('');

            if (displayedComments < allComments.length) {
                document.getElementById('loadMoreCommentsContainer').style.display = 'block';
            } else {
                document.getElementById('loadMoreCommentsContainer').style.display = 'none';
            }
        }

        // 댓글 작성
        function submitComment() {
            if (!currentUser) {
                alert('닉네임을 설정해주세요');
                return;
            }

            const content = document.getElementById('commentInput').value.trim();
            if (!content) {
                alert('댓글을 입력해주세요');
                return;
            }

            const comment = {
                id: Date.now().toString(),
                content,
                author: currentUser.nickname,
                createdAt: new Date().toISOString()
            };

            const commentsData = JSON.parse(localStorage.getItem('comments') || '{}');
            if (!commentsData[currentArticle.id]) {
                commentsData[currentArticle.id] = [];
            }
            commentsData[currentArticle.id].push(comment);
            localStorage.setItem('comments', JSON.stringify(commentsData));

            allComments.push(comment);
            allComments.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
            displayedComments = COMMENTS_PER_PAGE;
            renderComments();

            document.getElementById('commentInput').value = '';
        }

        // 댓글 취소
        function cancelComment() {
            document.getElementById('commentInput').value = '';
        }

        // 댓글 삭제
        function deleteComment(commentId) {
            if (!confirm('댓글을 삭제하시겠습니까?')) return;

            allComments = allComments.filter(c => c.id !== commentId);
            const commentsData = JSON.parse(localStorage.getItem('comments') || '{}');
            commentsData[currentArticle.id] = allComments;
            localStorage.setItem('comments', JSON.stringify(commentsData));

            renderComments();
        }

        // 더보기 댓글
        function loadMoreComments() {
            displayedComments += COMMENTS_PER_PAGE;
            renderComments();
        }

        // 날짜 포맷팅
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // HTML 이스케이프
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>